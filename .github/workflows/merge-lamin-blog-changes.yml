# yamllint disable rule:line-length
# yamllint disable rule:truthy
---
# Merges docs/changelog/soon/blog.md into docs/changelog/2026.md and opens a PR.
# Triggered by repository_dispatch from lamin-blog on merged pull requests
# with event_type: lamin-blog-merged and client_payload: { pr_number, merged_at }.
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Merged PR number in lamin-blog (e.g. 42)"
        required: true
        type: string
      merged_at:
        description: "Merge date ISO 8601 (e.g. 2026-02-27T12:34:56Z)"
        required: true
        type: string
  repository_dispatch:
    types:
      - lamin-blog-merged

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'repository_dispatch' && github.event.action == 'lamin-blog-merged')
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CROSS_REPO_TOKEN }}

      - name: Resolve PR and date
        id: resolve
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            PR_NUMBER="${{ github.event.client_payload.pr_number }}"
            MERGED_AT="${{ github.event.client_payload.merged_at }}"
          else
            PR_NUMBER="${{ inputs.pr_number }}"
            MERGED_AT="${{ inputs.merged_at }}"
          fi
          test -n "$PR_NUMBER" || { echo "pr_number is required"; exit 1; }
          test -n "$MERGED_AT" || { echo "merged_at is required"; exit 1; }
          DATE_STR=$(echo "$MERGED_AT" | cut -d'T' -f1)
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "date_str=$DATE_STR" >> "$GITHUB_OUTPUT"

      - name: Check soon file has content
        id: check
        run: |
          SOON_FILE="docs/changelog/soon/blog.md"
          if [ ! -f "$SOON_FILE" ] || [ ! -s "$SOON_FILE" ]; then
            echo "soon=$SOON_FILE is missing or empty; skipping merge (no-op)."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Merge blog.md into 2026.md
        if: steps.check.outputs.skip != 'true'
        run: |
          python3 - "docs/changelog/soon/blog.md" "docs/changelog/2026.md" "${{ steps.resolve.outputs.date_str }}" "${{ steps.resolve.outputs.pr_number }}" <<'PY'
          import sys
          from pathlib import Path
          soon_path = Path(sys.argv[1])
          changelog_path = Path(sys.argv[2])
          date_str = sys.argv[3]
          pr_number = sys.argv[4]
          content = soon_path.read_text().strip()
          heading = f"## {date_str} {{small}}`blog PR {pr_number}`"
          new_section = f"{heading}\n\n{content}\n\n"
          text = changelog_path.read_text()
          idx = text.find("\n## ")
          if idx == -1:
              raise SystemExit("No '## ' heading found in changelog")
          before = text[: idx + 1]
          after = text[idx + 1:]
          changelog_path.write_text(before + new_section + after)
          PY

      - name: Clear soon file
        if: steps.check.outputs.skip != 'true'
        run: |
          echo -n '' > docs/changelog/soon/blog.md

      - name: Create branch, commit, push
        if: steps.check.outputs.skip != 'true'
        env:
          PR_NUMBER: ${{ steps.resolve.outputs.pr_number }}
          DATE_STR: ${{ steps.resolve.outputs.date_str }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          RUN_ID_SHORT=${GITHUB_RUN_ID:0:8}
          [ -n "$RUN_ID_SHORT" ] || RUN_ID_SHORT=$GITHUB_RUN_ID
          BRANCH="chore/changelog/merge-lamin-blog-pr-${PR_NUMBER}-${RUN_ID_SHORT}"
          git checkout -b "$BRANCH" origin/main
          git add docs/changelog/2026.md docs/changelog/soon/blog.md
          git commit -m "chore(changelog): merge lamin-blog PR ${PR_NUMBER} (${DATE_STR}) into 2026.md"
          git push -u origin "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_ENV"

      - name: Open PR
        if: steps.check.outputs.skip != 'true'
        env:
          BRANCH: ${{ env.branch }}
          PR_NUMBER: ${{ steps.resolve.outputs.pr_number }}
        run: |
          gh pr create \
            --repo "$REPO" \
            --base main \
            --head "$BRANCH" \
            --title "üìù Blog PR ${PR_NUMBER}" \
            --body "Prepends content from docs/changelog/soon/blog.md to docs/changelog/2026.md and clears the soon file."

      - name: Merge PR into main
        if: steps.check.outputs.skip != 'true'
        env:
          BRANCH: ${{ env.branch }}
          REPO: ${{ github.repository }}
        run: |
          gh pr merge "$BRANCH" --repo "$REPO" --squash
